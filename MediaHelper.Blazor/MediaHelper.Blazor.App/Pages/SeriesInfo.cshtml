@page "/series/{SeriesId}"
@using MediaHelper.Blazor.App.Services
@using Episode = SonarrSharp.Models.Episode
@inject ApiClient Client

<div class="container">

    @if (Episodes == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <a target="_blank" href="http://localhost:8989/">Go to Sonarr</a>

        <ul class="collapsible popout">
            @{
                var order = Episodes.GroupBy(episode => episode.SeasonNumber).ToList();
            }
            @for (int i = order.Count()-1; i >= 0; i--)
            {
                var season = order[i];
                <li class="@(i == order.Count-1?"active":null)">
                    <div class="collapsible-header">Season: @season.Key</div>
                    <div class="collapsible-body">
                        <table class="series-table">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th></th>
                                <th>Name</th>
                                <th>Airdate</th>
                                <th>Download date</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var episode in season.OrderByDescending(episode => episode.EpisodeNumber))
                            {
                                <tr>
                                    <td class="episode-nr-cell">@episode.EpisodeNumber</td>
                                    <td class="episode-nr-cell">

                                        @if (!episode.HasFile)
                                        {
                                            <i class="far fa-play-circle link-active" onclick="@(() => OpenFile(episode.EpisodeFileId))"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-play-circle link-disable"></i>
                                        }
                                    </td>
                                    <td class="episode-title-cell">
                                        <a href="javascript:void(0)">@episode.Title</a>
                                    </td>
                                    <td class="episode-airdate-cell">@episode.AirDateUtc.LocalDateTime.ToString("HH:mm:ss")</td>
                                    <td class="episode--cell">TODO</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </li>
            }
        </ul>
    }

</div>

@functions
{

    [Parameter]
    public string SeriesId { get; set; }

    private Episode[] Episodes { get; set; }

    protected override async Task OnInitAsync()
    {
        Episodes = await Client.Episode.GetSeasons(int.Parse(SeriesId));
        StateHasChanged();
        await JSRuntime.Current.InvokeAsync<object>("addTooltip");
    }

    private async Task OpenFile(long episodeFileId)
    {
        await Client.System.OpenFile((int) episodeFileId, TimeSpan.Zero);
    }

}